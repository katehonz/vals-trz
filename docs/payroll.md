# Изчисляване на заплати

## Общ преглед

Изчисляването на заплати е ядрото на системата. То се извършва месечно за всеки служител и включва:

1. Основно възнаграждение
2. Допълнителни възнаграждения
3. Осигурителни вноски
4. Данък общ доход
5. Удръжки

## Алгоритъм за изчисляване

### Стъпка 1: Зареждане на данни

```
1. Работен календар за месеца
2. Часова карта на служителя
3. Осигурителни ставки (МРЗ, вноски, прагове)
4. Пера за възнаграждение на служителя
5. Пера за удръжки на служителя
```

### Стъпка 2: Изчисляване на основно възнаграждение

```
Основно възнаграждение = Базова заплата × (Отработени дни / Работни дни)
```

За почасово платени:
```
Основно възнаграждение = Почасова ставка × Отработени часове
```

### Стъпка 3: ДТВ за ТСПО

Допълнително трудово възнаграждение за трудов стаж и професионален опит:

```
ДТВ = Основно възнаграждение × Процент по стаж

Процент:
- До 1 година: 0%
- 1-2 години: 0.6%
- 2-3 години: 1.2%
- 3-5 години: 1.8%
- 5-10 години: 2.4%
- 10-15 години: 3.0%
- Над 15 години: 3.6%
```

### Стъпка 4: Допълнителни възнаграждения

#### Извънреден труд
```
Първите 150 часа: Основно × 1.5 / Норма часове × Часове извънреден
Над 150 часа: Основно × 2.0 / Норма часове × Часове извънреден
```

#### Нощен труд
```
Нощен труд = Основно × 0.15 / Норма часове × Нощни часове
```

#### СБКО (Състоял се брак по вина на организацията)
```
СБКО = Основно × Процент СБКО
```

#### Отпуск
```
Отпуск = Основно / Работни дни × Дни отпуск
```

#### Болничен
```
Първи 3 дни: 70% от дневното възнаграждение (за сметка на работодателя)
От 4-ти ден: 80% от дневното възнаграждение (за сметка на НОИ)
```

### Стъпка 5: Брутно възнаграждение

```
Брутно = Основно + ДТВ + Извънреден + Нощен + Отпуск + Болнични + Други
```

### Стъпка 6: Осигурителни вноски за сметка на работника

За родени преди 01.01.1960:
```
ДОО фонд "Пенсии": Брутно × 6.87%
ДОО фонд "ОЗРО": Брутно × 3.5%
ДОО фонд "Безработица": Брутно × 0.6%
ДЗПО-УПФ: Брутно × 2.8%
ЗО: Брутно × 3.2%

Общо: 16.97%
```

За родени след 01.01.1960:
```
ДОО фонд "Пенсии": Брутно × 9.79%
ДОО фонд "ОЗРО": Брутно × 3.5%
ДОО фонд "Безработица": Брутно × 0.6%
ЗО: Брутно × 3.2%

Общо: 17.09%
```

### Стъпка 7: Данък общ доход

```
Данъчна основа = Брутно - Осигуровки работник

ДОД = Данъчна основа × 10%
```

Необлагаем минимум за лица с намалена работоспособност: 9330 лв. годишно.

### Стъпка 8: Запори (ГПК чл. 446)

Изчисляват се върху нетото след осигуровки и данъци (първоначално нето).

1. Определя се секвестируемата част съгласно лимитите в ГПК (базирани на МРЗ).
2. Първо се удържат издръжките (без ограничение от МРЗ).
3. Остатъкът от лимита се разпределя по приоритет между другите запори.

[Детайлна документация за запори](./garnishments.md)

### Стъпка 9: Крайно нето възнаграждение

```
Нето = Първоначално нето - Удръжки по запори
```

### Стъпка 10: Осигурителни вноски за сметка на работодателя

За родени преди 01.01.1960:
```
ДОО фонд "Пенсии": Брутно × 9.79%
ДОО фонд "ОЗРО": Брутно × 3.5%
ДОО фонд "Безработица": Брутно × 0.6%
ДЗПО-УПФ: Брутно × 2.8%
ЗО: Брутно × 4.8%
ТЗПБ: по клас на икономическа дейност

Общо (без ТЗПБ): 21.49%
```

## Осигурителни прагове

### Минимален осигурителен доход

По категории персонал (НКПД):

| Категория | Мин. доход (лв.) |
|-----------|------------------|
| Ръководители | 933.00 |
| Специалисти | 933.00 |
| Техници | 933.00 |
| Служители | 933.00 |
| ... | ... |

### Максимален осигурителен доход

```
Максимум за 2024 г.: 3400.00 лв.
```

## Списание на Snapshot

След приключване на месеца се създава:

### PayrollSnapshot
```json
{
  "id": "snap123",
  "employeeId": "emp123",
  "month": 1,
  "year": 2024,
  "employeeData": {
    "fullName": "Иван Иванов Петров",
    "egn": "8001010000",
    "jobTitle": "Счетоводител",
    "baseSalary": 2000.00,
    "seniorityBonusPercent": 1.8
  },
  "earnings": [
    {"code": "101", "name": "Работна заплата", "amount": 2000.00},
    {"code": "201", "name": "Класс", "rate": 1.8, "amount": 36.00}
  ],
  "deductions": [
    {"code": "221", "name": "ДОО-Пнс,ОЗМ,Бзрб 3 Лс", "rate": 13.78, "amount": 281.18},
    {"code": "201", "name": "ЗО+СР Л", "rate": 3.2, "amount": 65.32},
    {"code": "500", "name": "ДОД", "amount": 168.95}
  ],
  "employerContributions": [
    {"code": "621", "name": "ДОО-Пнс,ОЗМ,Бзрб 3 Рс", "amount": 281.18},
    {"code": "601", "name": "ЗО+СР Р", "amount": 96.00}
  ],
  "grossSalary": 2072.00,
  "insurableIncome": 2072.00,
  "totalEmployeeInsurance": 351.68,
  "totalEmployerInsurance": 450.00,
  "taxBase": 1720.32,
  "incomeTax": 172.03,
  "netSalary": 1548.29,
  "totalEmployerCost": 2522.00,
  "timesheetData": {
    "workedDays": 22,
    "workDays": 22,
    "overtimeHours": 0
  }
}
```

### MonthClosingSnapshot
```json
{
  "companyId": "comp123",
  "month": 1,
  "year": 2024,
  "totalGross": 50000.00,
  "totalNet": 35000.00,
  "totalEmployeeInsurance": 8500.00,
  "totalEmployerInsurance": 10745.00,
  "totalTax": 4150.00,
  "employeeCount": 25,
  "parameters": {
    "insuranceRates": {...},
    "payItems": [...],
    "calendar": {...}
  }
}
```

### PayrollLine (ред от изчисление)

```json
{
  "code": "451",
  "name": "Запор: ЧСИ Петров",
  "type": "FIXED",
  "amount": 250.00,
  "rate": null,
  "quantity": null,
  "metadata": {
    "garnishmentId": "g123"
  }
}
```

Полета:
- `code` - код на перото
- `name` - наименование
- `type` - PERCENT, PER_UNIT, FIXED, CALCULATED
- `amount` - изчислена сума
- `rate` - процент (ако е приложимо)
- `quantity` - количество (ако е приложимо)
- `metadata` - допълнителни данни (напр. `garnishmentId` за автоматично следене на остатъка)

## Ведомости и справки

### Обща ведомост
Списък на всички служители с разбивка по пера.

### Рекапитулация
Обобщени суми по пера за целия месец.

### Индивидуален фиш
Детайлен фиш за всеки служител:
- Начисления
- Удръжки
- Осигуровки (работник + работодател)
- Нето за получаване

## Заключване на ведомост

След заключване:
1. Не се допускат промени в данните
2. Snapshot-ите се съхраняват перманентно
3. Месецът се маркира като "приключен"

За промяна е необходимо отключване от администратор.
