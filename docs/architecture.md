# Архитектура на системата

## Общ преглед

vals-trz използва **трислойна архитектура** с разделение между frontend, backend и база данни.

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│    Frontend     │     │    Backend      │     │    ArangoDB     │
│  React + TS     │────▶│  Spring Boot    │────▶│   NoSQL DB      │
│    (Vite)       │     │   (Java 21)     │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
      :5173                   :8080                  :8529
```

## Защо ArangoDB (NoSQL)?

Българското трудово и осигурително законодателство се променя често - нови МРЗ, осигурителни прагове, данъчни ставки, правила за отпуски. 

С релационна база данни би било необходимо:
- Версионни таблици за всяка настройка
- Сложни JOIN-ове за историческа навигация

С document database проблемът се решава елегантно чрез **snapshot модел**.

## Snapshot модел (ядрото на архитектурата)

Когато месецът се "затвори", системата създава **пълен JSON snapshot** на:

1. Всички законодателни параметри (МРЗ, осигурителни ставки, данък)
2. Фирмените настройки (пера, часови схеми, календар)
3. Данните на всеки служител (длъжност, заплата, стаж)
4. Самото изчисление (ред по ред - база, процент, сума)

**Един документ = пълна истина за този месец, завинаги.**

Дори законът да се промени 5 пъти след това, ведомостта за януари 2024 г. си остава точно такава, каквато е била. Може да се преглежда, разпечатва и одитира без никакъв риск от "замърсяване" с нови параметри.

### Две нива snapshot

| Snapshot | Ниво | Съдържание |
|----------|------|------------|
| `PayrollSnapshot` | Служител | Индивидуален фиш със всички изчисления |
| `MonthClosingSnapshot` | Фирма | Обща ведомост + всички параметри за месеца |

## Multi-tenant архитектура

Системата поддържа много наематели (фирми):

- Всеки entity има поле `tenantId` = Company.id
- API pattern: `/api/companies/{tenantId}/resource`
- Една инсталация обслужва много фирми

## Структура на Backend

```
backend/src/main/java/com/valstrz/
├── config/              # Конфигурация (CORS, ArangoDB, Security)
├── controller/          # REST контролери
├── entity/              # Доменни модели
│   ├── company/         # Фирмени данни
│   ├── insurance/       # Осигурителни вноски
│   ├── nomenclature/    # Номенклатури
│   ├── payroll/         # Заплати и ведомости
│   └── structure/       # Организационна структура
├── repository/          # ArangoDB репозитории
├── security/            # JWT автентикация
├── service/             # Бизнес логика
└── util/                # Помощни класове
```

## Структура на Frontend

```
frontend/src/
├── api/                 # API клиент
├── auth/                # Контекст за автентикация
├── components/          # React компоненти
│   ├── layout/          # Header, Sidebar
│   └── PayrollEntryModal.tsx  # Модален прозорец за фиш
├── pages/               # Страници
│   ├── PayrollPage.tsx         # Месечна ведомост
│   ├── PayItemsPage.tsx        # Пера за начисления
│   ├── DeductionItemsPage.tsx  # Пера за удръжки
│   ├── InsuranceThresholdsPage.tsx  # МОД по КИД
│   └── EmployeeDetailPage.tsx  # Детайли за служител
├── types/               # TypeScript интерфейси
├── App.tsx              # Главен компонент
└── main.tsx             # Входна точка
```

## Базови колекции в ArangoDB

### Document колекции

| Колекция | Описание |
|----------|----------|
| `companies` | Фирмени данни |
| `employees` | Лични данни на служители |
| `employments` | Трудови правоотношения |
| `departments` | Отдели и звена |
| `payItems` | Пера за възнаграждение |
| `deductionItems` | Пера за удръжки |
| `insuranceThresholds` | Минимален осигурителен доход по КИД |
| `nomenclatures` | Номенклатури |
| `monthlyCalendars` | Месечни работни календари |
| `workSchedules` | Часови схеми |
| `insuranceRates` | Осигурителни ставки |
| `absences` | Отсъствия |
| `timesheets` | Месечни часови карти |
| `payrolls` | Ведомости |
| `payrollEntries` | Записи във ведомост |
| `payrollSnapshots` | Snapshot-и на изчисленията |
| `documentTemplates` | Шаблони за документи |
| `leaveEntitlements` | Полагаеми отпуски |

### Edge колекции (графи)

| Колекция | Връзка |
|----------|--------|
| `belongsTo` | Служител → Отдел |
| `reportsTo` | Отдел → Родителски отдел |
| `hasEmployment` | Служител → Трудово правоотношение |

## Автентикация и авторизация

### JWT токени

- Използва се JWT (JSON Web Token) за автентикация
- Токенът се генерира при логин и се съхранява в localStorage
- Всяка заявка към API включва токена в header-а

### Роли

| Роля | Права |
|------|-------|
| Администратор | Пълен достъп до всички функции |
| Счетоводител | Заплати, декларации, плащания |
| HR мениджър | Персонал, документи |
| Ръководител | Read-only достъп |

## Одит лог

Всяка промяна на данни се записва в `AuditLog` колекция:

- Потребител, извършил промяната
- Дата и час
- Тип на операцията (CREATE, UPDATE, DELETE)
| Старата и новата стойност
