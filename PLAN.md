# План за разработка - vals-trz

Уеб-базирана ТРЗ система (Заплати и Човешки ресурси) по модела на EJ ARFA.
Технологии: Java 21 + Spring Boot, React + TypeScript, ArangoDB.

---

## Архитектурни принципи

### Защо ArangoDB (NoSQL)?
Българското трудово и осигурително законодателство се променя често - нови МРЗ,
осигурителни прагове, данъчни ставки, правила за отпуски. С релационна БД би
трябвало версионна таблица за всяка настройка и сложни JOIN-ове за историческа
навигация. С document DB проблемът се решава елегантно.

### Snapshot модел (ядрото на архитектурата)
Когато месецът се "затвори", системата създава **пълен JSON snapshot** на:
- Всички законодателни параметри (МРЗ, осиг. ставки, данък)
- Фирмените настройки (пера, часови схеми, календар)
- Данните на всеки служител (длъжност, заплата, стаж)
- Самото изчисление (ред по ред - база, процент, сума)

**Един документ = пълна истина за този месец, завинаги.**

Дори законът да се промени 5 пъти след това, ведомостта за януари 2024 г.
си остава точно такава, каквато е била. Може да се преглежда, разпечатва
и одитира без никакъв риск от "замърсяване" с нови параметри.

**Две нива snapshot:**
- `PayrollSnapshot` - на ниво служител (индивидуален фиш)
- `MonthClosingSnapshot` - на ниво фирма (обща ведомост + всички параметри)

### Multi-tenant
- Всеки entity има `tenantId` = Company.id
- API pattern: `/api/companies/{tenantId}/resource`
- Една инсталация обслужва много фирми

---

## Фаза 1: Фундамент (Данни и настройки)

Основата на системата - без тези настройки нищо друго не може да работи.

### 1.1 Фирмени данни
- **Entity**: `Company` - БУЛСТАТ/ЕИК, име, населено място, пощенски код, адрес на управление, адрес за кореспонденция, фирмено дело, телефон, електронен адрес, ТД на НАП
- **Entity**: `CompanyPersonnel` - данни за ръководител (име, длъжност, ЕГН, ЛК), лице подаващо в НАП, лице подаващо в НОИ
- **Entity**: `CompanySettings` - срок за изплащане, срок за предизвестие, бюджетно/небюджетно, осигурителна каса
- REST API: CRUD за фирмени данни
- Frontend: Форма с табове (За фирмата, Персонални данни, НКИД, За работа, За печата)

### 1.2 НКИД и видове персонал
- **Entity**: `EconomicActivity` - код на основна икономическа дейност по НКИД (Имплементирано)
- **Entity**: `PersonnelType` - видове персонал (Ръководители, Специалисти, Техници и др.) с минимален осигурителен доход по НКПД
- **Nomenclature**: Национален класификатор на професиите и длъжностите (НКПД) (Имплементирано: импорт на НКПД)

### 1.3 ДТВ за ТСПО
- **Entity**: `SeniorityBonusConfig` - процент за 1 година стаж (базов 0.6%), таблица с проценти по години стаж
- Логика: автоматично обновяване на процентите при приключване на месец

### 1.4 Времеви данни и параметри
- **Entity**: `MonthlyCalendar` - работни дни, календарни дни, почивни дни, празнични дни, работни часове на ден, общо работни часове за месеца
- **Entity**: `WorkSchedule` - часови схеми на работа (8ч пълно, 7ч, 6ч, 4ч, СИРВ и др.) с код и брой часове
- **Entity**: `AnnualCalendar` - годишен работен календар, официални празници
- Логика: зареждане на стандартен BG работен календар

### 1.5 Осигурителни вноски и прагове
- **Entity**: `InsuranceRates` - МРЗ, максимален осиг. доход, процент плосък данък, необлагаема сума за инвалиди
- **Entity**: `InsuranceContributions` - проценти за ДОО (фонд Пенсии, ОЗМ, Безработица), ДЗПО-УПФ, здравни - разделени на работодател/работник, за родените преди/след 1960
- **Entity**: `InsuranceThresholds` - минимални осигурителни прагове по групи НКПД
- **Entity**: `TZPBContributions` - вноски за фонд ТЗПБ по класове на икономическа дейност

### 1.6 Пера за възнаграждение
- **Entity**: `PayItem` - код, име, тип (% от, лева по, фиксирана сума, изчисляемо перо)
- Системни пера: основна заплата (351001), ДТВ за ТСПО (351041), извънреден труд (351061-351063), нощен труд (351091), СБКО (351111), отпуски (351301-351304), болнични (351631-351640), майчинство (351651-351655)
- REST API: CRUD + списък с пера
- Frontend: Таблица с пера, форма за добавяне/редакция

### 1.7 Пера за удръжки
- **Entity**: `DeductionItem` - код, име, тип (фиксирана сума, изчисляемо)
- Системни пера: аванс (351821-351822), ДОД (351982), осигурителни вноски (351901-351913)

### 1.8 Номенклатури
- **Entity**: `Nomenclature` - тип (служебна/потребителска), код, стойности
- Служебни: населено място, ЕКАТТЕ, банки (BIC), основания за ТД, основания за прекратяване, видове отпуск, родство и др.
- REST API: CRUD + попълване от CSV

---

## Фаза 2: Структура и персонал

### 2.1 Организационна структура
- **Entity**: `Department` - дървовидна структура (parent-child), име, код, ръководител
- ArangoDB: използване на graph за йерархията на отделите
- Frontend: Дървовидна визуализация + drag & drop

### 2.2 Лични данни на служител
- **Entity**: `Employee` - ЕГН/ЛНЧ, три имена, дата на раждане, пол, гражданство, адрес (постоянен + временен), телефон, email, ЛК данни, образование, семейно положение, брой деца, снимка
- REST API: CRUD + търсене по име/ЕГН
- Frontend: Форма с лични данни

### 2.3 Служебни данни
- **Entity**: `Employment` - номер и дата на ТД, дата на постъпване, основание (код), длъжност, код по НКПД, работно място, вид работно време, часова схема, вид осигуряване, вид осигурен, основно възнаграждение, вид заплащане (месечно/почасово/сделно)
- **Entity**: `Amendment` - допълнително споразумение (номер, дата, влизане в сила, основание, нови условия)
- **Entity**: `Termination` - заповед за прекратяване (номер, дата, последен работен ден, основание)
- Логика: история на промените (всяко ДС пази snapshot на променените условия)

### 2.4 Възнаграждения на служител
- **Entity**: `EmployeePayItem` - служител + перо + стойност + период (от месец/година)
- Типове: почасови, като лв. по, еднократни, многократни
- Логика: автоматично начисляване на ДТВ за ТСПО по стаж

### 2.5 Удръжки на служител
- **Entity**: `EmployeeDeduction` - служител + перо удръжка + стойност + период

### 2.6 Отсъствия
- **Entity**: `Absence` - служител, вид отсъствие (код), от дата, до дата, работни дни, статус
- Видове: платен отпуск, неплатен (признат/непризнат за стаж), учебен, служебен, болничен (общо заболяване, трудова злополука, проф. болест, битова злополука), майчинство (бременност, бащинство, отглеждане до 2г/3г/8г), самоотлъчка
- **Entity**: `SickLeave` - допълнителни данни за болничен (Декларация 15, дни за сметка на работодателя/НОИ)
- Логика: проверка за налични дни отпуск, автоматично изчисляване на работни дни в периода

### 2.7 Часова месечна карта
- **Entity**: `MonthlyTimesheet` - служител + месец + масив от дневни записи
- **ValueObject**: `DailyEntry` - ден, вид (работен/почивен/празничен/отсъствие), часове работа, извънреден труд, нощен труд, код отсъствие
- Frontend: Таблица-календар за месеца с колони по дни

### 2.8 Полагаеми отпуски
- **Entity**: `LeaveEntitlement` - служител, година, вид отпуск, полагаеми дни, използвани дни, остатък
- Логика: автоматично изчисляване на полагаем отпуск по чл. 155, 156 от КТ

---

## Фаза 3: Изчисляване на заплати

### 3.1 Месечна ведомост (ядро на системата)
- **Entity**: `Payroll` - месец, година, статус (отворена/заключена/съхранена)
- **Entity**: `PayrollEntry` - служител + ведомост + всички начисления и удръжки
- Алгоритъм за изчисляване:
  1. Зареждане на работния календар и часовата карта на служителя
  2. Изчисляване на основно възнаграждение (пропорционално на отработени дни)
  3. Начисляване на ДТВ за ТСПО
  4. Начисляване на допълнителни възнаграждения (извънреден труд, нощен, СБКО и др.)
  5. Изчисляване на обезщетения за отпуск и болнични
  6. Брутно възнаграждение = сума от всички пера
  7. Осигурителни вноски за сметка на работника (ДОО, ДЗПО, ЗО)
  8. Данък общ доход (10% върху данъчната основа)
  9. Нето = Брутно - осигуровки работник - ДОД - други удръжки
  10. Осигуровки за сметка на работодателя

### 3.2 Ведомости за заплати
- Обща ведомост - всички служители, колони за всяко перо
- Ведомост-рекапитулация - обобщени суми по пера
- Ведомост по отдели

### 3.3 Фишове за заплата
- Индивидуален фиш на всеки служител
- Печат и електронни фишове (PDF)
- Начисления, удръжки, осигуровки (работник + работодател), нето за получаване

---

## Фаза 4: Документи и шаблони

### 4.1 Шаблони на документи
- **Entity**: `DocumentTemplate` - име, тип (трудов документ / длъжностна характеристика), съдържание (RTF/HTML)
- Система от кодове за заместване: `#nnnnn#` (данни от фирмата/служителя)
- Системни шаблони (предефинирани) + фирмени шаблони (редактирани)

### 4.2 Трудови документи
- Трудов договор - автоматично генериране по шаблон
- Допълнително споразумение
- Заповед за прекратяване
- Длъжностна характеристика

### 4.3 Оперативни документи
- Заповед за отпуск
- Заповед за командировка
- Служебни бележки

### 4.4 Графици и СИРВ
- Графици по смени (дневна, нощна, 12/24, 12/48)
- Сумирано изчисляване на работното време
- Присъствена ведомост

### 4.5 Сделни заработки
- Индивидуални работни карти (ИРК)
- Групови работни карти (бригадни)
- Разценки по операции и изделия
- Справки по работни карти

---

## Фаза 5: Данни за НАП и НОИ

### 5.1 Декларация 1
- Месечни данни за осигурени лица
- Формиране на файл по формата на НАП
- Валидация по правилата на НАП

### 5.2 Декларация 6
- Данни за дължими вноски (обобщени суми)
- Формиране на файл

### 5.3 Уведомления по чл. 62
- При сключване/изменение/прекратяване на ТД
- Еднократна начална регистрация
- Формиране на файл по формат на НАП

### 5.4 Уведомления по чл. 123
- При промяна на работодател (сливане, вливане, отделяне)

### 5.5 Данни за НОИ
- Приложение 9 / Приложение 10 - болнични листове
- Обработка на дни за временна нетрудоспособност
- Формиране на файл по формат на НОИ

---

## Фаза 6: Удостоверения, справки и плащания

### 6.1 Удостоверения
- Лични удостоверения за доход
- Декларации (Декл. по чл. 73 ЗДДФЛ)
- Служебни бележки (облагаеми/необлагаеми доходи)
- УП-2 (осигурителен доход), УП-3 (осигурителен стаж)

### 6.2 Рекапитулация и статистика
- Обща рекапитулация - обобщение на всички пера за период
- По категории персонал
- Консолидирана (за няколко фирми)
- Данни за НСИ
- Аналитични графики (брой персонал, разходи по месеци)
- Анализ на персонала (текучество, средна заплата, разпределение по възраст)

### 6.3 Банкови плащания
- Банкови сметки на персонала (IBAN, BIC)
- Масови плащания - формиране на файл за банков превод
- Платежни документи за НАП (осигуровки, данъци)

### 6.4 Счетоводни операции
- Осчетоводяване на заплати (контировки)
- Полагаем и остатъчен отпуск (провизии)
- Компенсируемост

---

## Фаза 7: Администриране и сервиз

### 7.1 Месечен цикъл
- Започване на нов месец (прехвърляне на данни)
- Съхраняване на ведомост (архивиране)
- Заключване/отключване на изчисленията

### 7.2 Синхронизация
- Между месеци - обновяване на промени в минали месеци
- Между години - прехвърляне на данни при годишно приключване

### 7.3 Импорт/Експорт
- [x] Импорт на номенклатури (НКПД) от CSV
- [x] Импорт на осигурителни прагове (МОД/ТЗПБ) от CSV
- [x] Импорт на данни за персонала от CSV
- Експорт на справки в Excel/PDF

### 7.4 Потребители и права
- Автентикация (JWT)
- Роли: Администратор, Счетоводител, HR мениджър, Ръководител (read-only)
- Одит лог - кой какво е променил и кога

---

## Приоритет на разработка

| Приоритет | Фаза | Описание | Зависимости |
|-----------|------|----------|-------------|
| 1 | 1.1-1.2 | Фирмени данни, НКИД | - |
| 2 | 1.4 | Времеви данни, календар | - |
| 3 | 1.5 | Осигурителни вноски | - |
| 4 | 1.6-1.7 | Пера за възнаграждение/удръжки | - |
| 5 | 2.1 | Организационна структура | 1.1 |
| 6 | 2.2-2.3 | Служители (лични + служебни) | 1.2, 2.1 |
| 7 | 2.6-2.7 | Отсъствия, часова карта | 2.2, 1.4 |
| 8 | 3.1 | Изчисляване на заплати | 1.4-1.7, 2.2-2.7 |
| 9 | 3.2-3.3 | Ведомости, фишове | 3.1 |
| 10 | 5.1-5.5 | Декларации НАП/НОИ | 3.1 |
| 11 | 4.1-4.5 | Документи и шаблони | 2.2-2.3 |
| 12 | 6.1-6.4 | Удостоверения, плащания | 3.1 |
| 13 | 7.1-7.4 | Администриране, сервиз | Всички |

---

## Модел на данните (ArangoDB колекции)

### Document колекции
- `companies` - фирмени данни
- `employees` - лични данни на служители
- `employments` - трудови правоотношения (ТД, ДС, прекратяване)
- `departments` - отдели и звена
- `payItems` - пера за възнаграждение
- `deductionItems` - пера за удръжки
- `nomenclatures` - номенклатури
- `monthlyCalendars` - месечни работни календари
- `workSchedules` - часови схеми
- `insuranceRates` - осигурителни ставки
- `absences` - отсъствия
- `timesheets` - месечни часови карти
- `payrolls` - ведомости
- `payrollEntries` - записи във ведомост (по служител)
- `documentTemplates` - шаблони за документи
- `leaveEntitlements` - полагаеми отпуски
- `bankAccounts` - банкови сметки

### Edge колекции (ArangoDB графи)
- `belongsTo` - служител -> отдел
- `reportsTo` - отдел -> родителски отдел
- `hasEmployment` - служител -> трудово правоотношение
