# Архитектурни решения на vals-trz

## Как стигнахме до тази архитектура

Архитектурата на vals-trz е резултат от продължителен анализ и дискусии с AI асистенти (Claude, Gemini) за намиране на най-подходящия технологичен стек за ТРЗ система в български условия. Основният въпрос беше: **каква е най-добрата архитектура за система, която трябва да се адаптира към постоянно променящо се законодателство?**

## Защо NoSQL (ArangoDB)?

### Проблемът с българското трудово законодателство

Българското осигурително и данъчно законодателство се променя **минимум веднъж годишно**, а нерядко и **по два-три пъти в рамките на една година**:

- Промяна на МРЗ (минимална работна заплата)
- Нови осигурителни прагове по НКПД
- Промяна на процентите за ДОО, ДЗПО, ЗО
- Нови изисквания към Декларация 1 и Декларация 6
- Промени в данъчните облекчения и удръжки
- Нови формати за подаване на данни към НАП и НОИ
- Промени в Кодекса на труда (отпуски, обезщетения, прекратяване)

### Защо релационна база данни е проблем за ТРЗ

При класическа SQL база всяка законодателна промяна означава:

1. **ALTER TABLE миграции** - добавяне/премахване на колони при нови полета
2. **Миграционни скриптове** - поддръжка на верига от миграции, която расте всяка година
3. **Downtime при миграция** - промяна на схемата на таблици с милиони записи
4. **Rigidity** - твърдата схема пречи на бързата адаптация
5. **Snapshot проблем** - трудно е да се запази точното състояние на ведомостта към момента на приключване на месеца, когато структурата на данните се променя

### Защо ArangoDB е правилният избор

ArangoDB като документна NoSQL база решава тези проблеми:

- **Schema-free документи** - нови полета се добавят без миграции. Ако НАП изиска ново поле в Декларация 1, просто го добавяме в документа
- **Snapshot модел** - при приключване на месец, цялото състояние на ведомостта се записва като неизменяем документ (`PayrollSnapshot`, `MonthClosingSnapshot`). Дори структурата да се промени следващия месец, историческите данни остават непокътнати
- **Multi-model** - ArangoDB поддържа документи, графи и key-value в една база. Организационната структура (отдели, йерархия) естествено се моделира като граф
- **Гъвкави заявки (AQL)** - мощен език за заявки, сравним с SQL, но без ограниченията на твърда схема
- **Производителност** - бърз достъп до вложени документи без JOIN-ове

### Конкретен пример

При промяна на осигурителните проценти от 01.01.2026:

**С SQL база:**
```
ALTER TABLE insurance_rates ADD COLUMN new_fund_rate DECIMAL(5,2);
-- миграция на съществуващи записи
-- обновяване на всички stored procedures
-- тестване на обратна съвместимост
```

**С ArangoDB:**
```
// Просто записваме нов документ с новата структура
// Старите документи си остават непроменени
// Snapshot-ите от предишни месеци не се засягат
```

## Технологичен стек

### Backend: Java 21 + Spring Boot 3.4

- **Java 21** - LTS версия, виртуални нишки (Project Loom), pattern matching
- **Spring Boot** - зряла екосистема, spring-data-arangodb за интеграция с базата
- **JWT автентикация** - stateless, подходящо за REST API
- **OpenPDF / Apache POI** - генериране на PDF фишове и Excel справки

### Frontend: React + TypeScript + Vite

- **React 19** - компонентна архитектура, подходяща за сложни форми (ведомости, лични картони)
- **TypeScript** - типова безопасност за сложния domain модел
- **Vite** - бързо развитие и hot reload

### Инфраструктура: Docker

- **ArangoDB в Docker** - лесно разгръщане, изолация, версионен контрол на базата

## Архитектурни принципи

### 1. Multi-tenant по компания

Всеки entity има `tenantId` = Company ID. Една инсталация обслужва множество фирми. API pattern: `/api/companies/{tenantId}/resource`.

### 2. Immutable snapshots

При приключване на месец се създават неизменяеми снимки:
- `PayrollSnapshot` - за всеки служител
- `MonthClosingSnapshot` - за цялата фирма

Това гарантира, че историческите данни не се засягат от бъдещи промени в законодателството или структурата на данните.

### 3. Separation of concerns

```
Controller (REST API)
    └── Service (бизнес логика, изчисления)
        └── Repository (достъп до ArangoDB)
            └── Entity (документен модел)
```

### 4. Гъвкав модел на пера

Перата за възнаграждение и удръжки са конфигурируеми, не hardcoded. Това позволява адаптация към нови законови изисквания без промяна на кода.

## Алтернативи, които бяха разгледани и отхвърлени

| Вариант | Причина за отхвърляне |
|---------|----------------------|
| PostgreSQL + JSONB | Хибриден подход, но миграциите на релационната част остават проблем |
| MongoDB | Липса на multi-model (графи за организационна структура), по-слаба заявка |
| MySQL/MariaDB | Твърда схема, тежки миграции при чести промени |
| Microservices | Прекалена сложност за ТРЗ система, monolith е по-подходящ |
| Event Sourcing | Интересен подход, но прекалено сложен за първа версия |

## Заключение

Изборът на NoSQL (ArangoDB) не е мода, а **практическо решение** за специфичен проблем - българското законодателство се променя твърде често, за да се поддържа ефективно твърда релационна схема. Document-базираният модел със snapshot-и е най-естественият начин да се моделира ТРЗ система, където всеки месец трябва да бъде "замразен" точно такъв, какъвто е бил.
